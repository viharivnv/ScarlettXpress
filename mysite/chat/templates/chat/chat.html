<!DOCTYPE html>
<html>
<head>
    <title>Chat</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.2/css/all.css">
    <style type="text/css">
      body {
        background: url(https://i.imgur.com/ePYJn6n.png);
        background-size:cover;
        background-repeat: no-repeat;
        color: gray;
      }
      h1 {
        padding-bottom: 30px;
        background: rgba(0, 0, 0, 0.3);
      }
       button.convo {
         background-color: #FF8888;
         color: white;
         padding: 14px 20px;
         margin: 8px 0;
         border: none;
         cursor: pointer;
         width: 100%;
         height: 75px;
       }
       button.search {
         background-color: #FF8888;
         color: white;
         padding: 9px 20px;
         margin: 8px 0;
         border: none;
         cursor: pointer;
         width: 20%;
         right: 0;
         height = 100%;
       }

       button:hover {
         opacity: 0.8;
        }
      .navbar-inverse {
        background: red;
      }

      h4 {
        padding-bottom: 30px;
        padding-top: 20px;
      }

      h3 {
        text-align: center;
      }

      .btn-block {
        background: rgba(0, 0, 0, 0.6);
      }

      .col-lg-6 {
        padding-bottom: 20px;
      }

      .sample{
        color: maroon;
      }

      .sample1{
        color: #ffc266;
      }
        .div1 {
        width: 300px;
        height: 100px;
        border: 1px solid blue;
        }
      .conversations {
        position: absolute;
        left: 0;
        width:34%;
        top: 173px;
        bottom: 0;
        border: 3px solid red;
        padding: 5px;
        font: 24px/36px sans-serif;
        overflow-y: scroll;
        object-fit: fill;
      }
      .chat {
        position: absolute;
        right: 0%;
        width:66%;
        top: 173px;
        bottom: 35px;
        border: 3px solid red;
        padding: 5px;
        font: 24px/36px sans-serif;
        overflow-y: scroll;
        object-fit: fill;
      }
      ::-webkit-scrollbar {
        width: 12px;
        height: 12px;
      }
      ::-webkit-scrollbar-track {
        border: 1px solid red;
        border-radius: 10px;
      }
      ::-webkit-scrollbar-thumb {
        background: red;
        border-radius: 10px;
      }
        ::-webkit-scrollbar-thumb:hover {
        background: maroon;
      }
      input.search[type=text] {
        left: 0;
        width: 80%;
        height: 100%;
        border: 2px solid #ddd;
        font-size: 16px;
      }
      input.message[type=text] {
        right: 10%;
        width: 80%;
        height: 100%;
        bottom: 2px;
        border: 2px solid #ddd;
        font-size: 16px;
      }

      button.record {
         background-color: #FF8888;
         color: white;
         padding: 9px 20px;
         margin: 8px 0;
         border: none;
         cursor: pointer;
         width: 10%;
         right: 0;
         height = 100%;
       }

      button.send {
         background-color: #FF8888;
         color: white;
         padding: 9px 20px;
         margin: 8px 0;
         border: none;
         cursor: pointer;
         width: 10%;
         right: 0;
         height = 100%;
       }

      button.sent {
        background-color: #FFAAAA;
         color: white;
         border: none;
         cursor: pointer;
         right: 10px;
         width: 100%;
         height: 40px;
      }

      button.received {
        background-color: #CCCCCC;
         color: black;
         border: none;
         cursor: pointer;
         left: 10px;
         width: 100%;
         height: 40px;
      }

      .wrapper {
          position: absolute;
          float: left;
          top: 123px;
          height: 40px; /* needs to be defined in this case so that the children know what they should be 100% height of */
          width: 34%;
      }
      .wrapper2 {
          position: absolute;
          right: 0;
          bottom: 0;
          height: 40px; /* needs to be defined in this case so that the children know what they should be 100% height of */
          width: 66%;
      }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark navbar-inverse">
    <a class="navbar-brand {{ myhome_page }}" href="{% url 'Home' %}">ScarletXpress</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav mr-auto">
            <li class="nav-item {{ predict_page }}">
                <a class="nav-link" href="">Course Planner<span class="sr-only">(current)</span></a>
            </li>
            <li class="nav-item {{ predict_page }}">
                <a class="nav-link" href="">Course Registration<span class="sr-only">(current)</span></a>
            </li>
            <li class="nav-item {{ analysis_page }}">
                <a class="nav-link" href="">Term Bill</a>
            </li>
            <li class="nav-item {{ analysis_page }}">
                <a class="nav-link" href="{% url 'chat' %}">Chat</a>
            </li>
            <li class="nav-item {{ compare_page }}">
                <a class="nav-link" href="">Accessibility</a>
            </li>


        </ul>
        <ul class="navbar-nav ml-auto">

            <li class="nav-item">
                <a class="nav-link" href="">Update Password</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="">Logout</a>
            </li>
        </ul>
    </div>
</nav>

<h1 class="text-center sample">Course Chat</h1>
<div class="wrapper">
      <input class="search" type="text" id="search" placeholder="Search..."><button class="search" onclick="updateConversations()">Search</button>
</div>
<div class="conversations" id="conversations">
</div>
<div class="chat" id="chat"></div>
<div class="wrapper2">
  <button class="record" onclick="voiceToText()">Record</button><input class="message" type="text" id="message" placeholder="Message..."><button class="send" onclick="sendMessage()">Send</button>
</div>

<script>
var inHelp = false;
var student = 'Student';
var currchatid = 0;

var helpRequests = [
    { command: 'help', message: 'commands are help, chat, termbill, webreg, courseplanner, myrutgers' },
    { command: 'chat', message: 'commands are help, chat, termbill, webreg, courseplanner, myrutgers' },
    { command: 'termbill', message: 'commands are help, chat, termbill, webreg, courseplanner, myrutgers' },
    { command: 'webreg', message: 'commands are help, chat, termbill, webreg, courseplanner, myrutgers' },
    { command: 'courseplanner', message: 'commands are help, chat, termbill, webreg, courseplanner, myrutgers' },
    { command: 'myrutgers', message: 'commands are help, chat, termbill, webreg, courseplanner, myrutgers' },
];

let help = [
];

window.onload = load();

function load(){
    updateConversations();
    updateMessages(currchatid);
}

function updateConversations(){
    var conversations = document.getElementById("conversations");
    var search = document.getElementById("search").value;
    while (conversations.hasChildNodes())
        conversations.removeChild(conversations.lastChild);
    var helpButton = document.createElement("BUTTON");
    helpButton.className = "convo";
    helpButton.innerHTML = "Help";
    helpButton.addEventListener('click', updateHelp);
    conversations.appendChild(helpButton);
    var j;
    for (var i in chatlist) {
        if(search === "" || chatlist[i].members.find(member => member.toLowerCase().includes(search.toLowerCase()))){
            if(checkIfChatContainsStudent(i, student)){
                var button = document.createElement("BUTTON");
                button.className = "convo";
                for (j = 0; j < chatlist[i].members.length; j++) {
                    if(!(chatlist[i].members[j] === student))
                        button.innerHTML += (chatlist[i].members[j] + ", ");
                }
                button.innerHTML = button.innerHTML.slice(0, -2)
                const input = chatlist[i].id;
                button.addEventListener('click', function(){
                    updateMessages(input);
                });
                conversations.appendChild(button);
            }
        }
    }
    var addButton = document.createElement("BUTTON");
    addButton.className = "convo";
    addButton.innerHTML = "Add";
    addButton.addEventListener('click', addChat);
    conversations.appendChild(addButton);
}

function updateMessages(i){
    inHelp = false;
    var chatlog = document.getElementById("chat");
    while (chatlog.hasChildNodes())
        chatlog.removeChild(chatlog.lastChild);
    currchatid = i;
    var j;
    var top = 0;
    if(chats[i].length - 50 >=0)
        top = chats[i].length - 50;
    for (j = top; j < chats[i].length; j++) {
        var button = document.createElement("BUTTON");
        if(student === chats[i][j].sender){
            button.className = "sent";
        }
        else{
            button.className = "received";
        }
        button.innerHTML = chats[i][j].sender + ": " + chats[i][j].message;
        chatlog.appendChild(button);
    }
}

function updateHelp(){
    inHelp = true;
    var chatlog = document.getElementById("chat");
    while (chatlog.hasChildNodes()) {
        chatlog.removeChild(chatlog.lastChild);
    }
    var j;
    for (j = 0; j < help.length; j++) {
        var button = document.createElement("BUTTON");
        if(student === help[j].sender){
            button.className = "sent";
        }
        else{
            button.className = "received";
        }
        button.innerHTML = help[j].sender + ": " + help[j].message;
        chatlog.appendChild(button);
    }
}

function sendMessage(){
    var message = document.getElementById("message").value;
    if(!(message === "")){
        if(inHelp){
            help.push({ sender: student, message: message});
            helpRequests.forEach((request) => {
              if(message.includes(request.command))
                help.push({ sender: 'helpbot', message: request.message});
            });
            updateHelp();
        }
        else{
            chats[currchatid].push({ sender: student, message: message});
            updateMessages(currchatid);
        }
    }
}

function addChat(){
    var search = document.getElementById("search").value;
    if(!(search === "") && !checkDatabaseForChat([])){
        var i = Object.keys(chatlist).length;
        chatlist[i] = {members: [student, search], id: i};
        document.getElementById("search").value = "";
        updateConversations();
    }
}

function checkDatabaseForChat(list){ //TODO
    for(var i in chatlist){
        if(checkIfListsSame(chatlist[i].members, list)
            return true;
    }
    return false;
}

function checkIfListsSame(a, b){
    if(a.length == a.length){
        var temp = true;
        for(var m in a){
            if(!b.find(member => member === m)
               return false;
        }
        return true;
    }
    return false;
}

function checkDatabaseForStudent(name){ //TODO
    return false;
}

function checkIfChatContainsStudent(i, name){ //TODO
    if(chatlist[i].members.find(member => member === name)
        return true;
    else
        return false;
}

// new speech recognition object
var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
var recognition = new SpeechRecognition();

// This runs when the speech recognition service starts
recognition.onstart = function() {
    console.log("We are listening. Try speaking into the microphone.");
};

recognition.onspeechend = function() {
    // when user is done speaking
    recognition.stop();
}

// This runs when the speech recognition service returns result
recognition.onresult = function(event) {
    document.getElementById("message").value += event.results[0][0].transcript;
    var confidence = event.results[0][0].confidence;
};

function voiceToText(){
    recognition.start();
}
</script>
</body>
</html>